<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurus Pro | Multi-Column Registry v9.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #6366f1; --navy: #0f172a; --bg: #f1f5f9; --border: #e2e8f0;
            --critical-bg: #fee2e2; --critical-text: #991b1b;
            --amber-bg: #fef3c7; --amber-text: #92400e;
            --green-bg: #dcfce7; --green-text: #166534;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); display: flex; color: #1e293b; }

        nav { width: 260px; background: var(--navy); padding: 40px 20px; position: fixed; height: 100vh; z-index: 100; color: white; }
        nav h1 { font-size: 22px; margin-bottom: 40px; font-weight: 800; letter-spacing: -1px; }
        nav h1 span { color: var(--brand); }
        nav button { width: 100%; text-align: left; border: none; padding: 14px; border-radius: 12px; background: transparent; color: #94a3b8; font-weight: 600; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        nav button.active { background: var(--brand); color: white; }

        .workspace { margin-left: 260px; flex: 1; padding: 40px; width: calc(100% - 260px); }
        
        /* LOGIC-BASED ROW STAINING */
        .row-resolved { background-color: var(--green-bg) !important; color: var(--green-text); }
        .row-progress { background-color: var(--amber-bg) !important; color: var(--amber-text); }
        .row-critical { background-color: var(--critical-bg) !important; color: var(--critical-text); font-weight: 600; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 20px; border: 1px solid var(--border); }
        
        .glass-card { background: white; border-radius: 24px; padding: 35px; border: 1px solid var(--border); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .span-2 { grid-column: span 2; } .span-3 { grid-column: span 3; }
        label { font-size: 11px; font-weight: 800; color: #475569; text-transform: uppercase; }
        input, select, textarea { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #f8fafc; font-size: 14px; }

        .table-container { background: white; border-radius: 20px; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1800px; }
        th { background: #f8fafc; color: #64748b; padding: 18px 15px; text-align: left; font-weight: 700; border-bottom: 2px solid var(--border); position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); white-space: normal; vertical-align: middle; }

        .badge { padding: 4px 10px; border-radius: 30px; font-size: 9px; font-weight: 800; text-transform: uppercase; border: 1px solid rgba(0,0,0,0.1); }
        .btn-main { background: var(--brand); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 800; cursor: pointer; width: 100%; }
        .hidden { display: none; }
        .action-icon { cursor: pointer; font-size: 16px; margin-right: 8px; opacity: 0.7; }
        .action-icon:hover { opacity: 1; }
    </style>
</head>
<body>

<nav>
    <h1>AURUS <span>PRO</span></h1>
    <button id="n1" class="active" onclick="view('entryPage', this)">‚ûï New Incident</button>
    <button id="n2" onclick="view('historyPage', this)">üìã Master Registry</button>
    <div style="margin-top:20px; padding: 0 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <button onclick="exportJSON()" style="font-size:11px; opacity: 0.6;">üì§ Backup JSON</button>
        <button onclick="clearAllData()" style="color:#ef4444; font-size:11px; opacity: 0.6;">üóëÔ∏è Purge DB</button>
    </div>
</nav>

<div class="workspace">
    <div class="stats-grid">
        <div class="stat-card"><small>Total Cases</small><h3 id="statTotal">0</h3></div>
        <div class="stat-card"><small>Critical Open</small><h3 id="statCrit" style="color:#ef4444">0</h3></div>
        <div class="stat-card"><small>Resolution Rate</small><h3 id="statRes">0%</h3></div>
        <div class="stat-card"><small>Unique Clients</small><h3 id="statClients">0</h3></div>
    </div>

    <div id="entryPage" class="entry-container">
        <h2 id="formHeader" style="font-weight:800; margin-bottom: 25px;">Incident Registration</h2>
        <div class="glass-card">
            <input type="hidden" id="editId">
            <div class="form-grid">
                <div class="form-group span-2"><label>Email Subject</label><input type="text" id="emailSubject" placeholder="Title of the issue..."></div>
                <div class="form-group"><label>Category</label><input type="text" id="category" placeholder="e.g. Database, UI, Network"></div>
                
                <div class="form-group span-3"><label>Technical Summary</label><textarea id="description" rows="3"></textarea></div>
                
                <div class="form-group"><label>Affected Node</label><input type="text" id="reportedNode"></div>
                <div class="form-group"><label>Network Wide?</label><select id="allNodes"><option>No</option><option>Yes</option></select></div>
                <div class="form-group"><label>Client Name</label><input type="text" id="clientName"></div>

                <div class="form-group"><label>Impact Severity</label>
                    <select id="severity"><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select>
                </div>
                <div class="form-group"><label>Impacted Module</label><input type="text" id="impactedModule"></div>
                <div class="form-group"><label>Current Lifecycle Status</label>
                    <select id="status"><option>Open</option><option>In Progress</option><option>Resolved</option></select>
                </div>

                <div class="form-group"><label>Date Reported</label><input type="date" id="dateReported" onchange="calcDates(this.value)"></div>
                <div class="form-group"><label>Estimated Resolution (ETA)</label><input type="date" id="eta"></div>
                <div class="form-group"><label>Action Owner</label><input type="text" id="actionOwner"></div>

                <div class="hidden">
                    <input type="text" id="month"><input type="text" id="quarter">
                </div>

                <div class="form-group span-3"><label>Internal Developer Comments</label><textarea id="comments" rows="2"></textarea></div>
                
                <div class="span-3"><button id="submitBtn" class="btn-main" onclick="save()">üöÄ Sync Case to Master Registry</button></div>
            </div>
        </div>
    </div>

    <div id="historyPage" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <input type="text" id="tableSearch" placeholder="üîç Search by Subject, Node, Client..." onkeyup="filterTable()" style="padding:12px; border-radius:10px; border:1px solid var(--border); width:400px;">
            <button class="btn-main" onclick="exportColoredExcel()" style="width:auto; padding:12px 25px; background:#166534">üìó Export Full Registry to Excel</button>
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width: 250px;">Email Subject</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Severity</th>
                        <th>Client</th>
                        <th>Node</th>
                        <th>Module</th>
                        <th>Owner</th>
                        <th>Date</th>
                        <th>ETA</th>
                        <th>Month</th>
                        <th>Qtr</th>
                        <th>NW</th>
                        <th>Developer Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="logTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let db;
    const fields = ["emailSubject", "description", "category", "reportedNode", "allNodes", "clientName", "severity", "impactedModule", "dateReported", "status", "eta", "month", "quarter", "actionOwner", "comments"];

    const req = indexedDB.open("AurusV9FullUtilityDB", 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore("logs", { keyPath: "id" });
    req.onsuccess = e => { db = e.target.result; renderHistory(); };

    function calcDates(val) {
        if(!val) return;
        const d = new Date(val);
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        document.getElementById('month').value = months[d.getMonth()];
        document.getElementById('quarter').value = "Q" + Math.floor((d.getMonth() + 3) / 3);
    }

    function view(id, btn) {
        document.getElementById('entryPage').classList.toggle('hidden', id !== 'entryPage');
        document.getElementById('historyPage').classList.toggle('hidden', id !== 'historyPage');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(id === 'historyPage') renderHistory();
    }

    function save() {
        const tx = db.transaction("logs", "readwrite");
        const existingId = document.getElementById('editId').value;
        const data = { id: existingId || "ID-" + Date.now(), updated: new Date().toISOString() };
        fields.forEach(f => data[f] = document.getElementById(f).value);
        
        tx.objectStore("logs").put(data).onsuccess = () => {
            alert("Registry Successfully Updated");
            fields.forEach(f => { if(document.getElementById(f).tagName !== "SELECT") document.getElementById(f).value = ""; });
            document.getElementById('editId').value = "";
            view('historyPage', document.getElementById('n2'));
        };
    }

    function renderHistory() {
        const tbody = document.getElementById("logTableBody");
        tbody.innerHTML = "";
        let s = { total: 0, crit: 0, res: 0, clients: new Set() };

        db.transaction("logs", "readonly").objectStore("logs").openCursor(null, 'prev').onsuccess = e => {
            const c = e.target.result;
            if(c) {
                const v = c.value;
                s.total++; 
                if(v.severity === 'Critical' && v.status !== 'Resolved') s.crit++; 
                if(v.status === 'Resolved') s.res++; 
                if(v.clientName) s.clients.add(v.clientName);

                const row = document.createElement("tr");
                
                // --- COLOR LOGIC ---
                if(v.status === 'Resolved') row.className = "row-resolved";
                else if(v.status === 'In Progress') row.className = "row-progress";
                else if(v.severity === 'Critical') row.className = "row-critical";

                row.innerHTML = `
                    <td><b>${v.emailSubject || ''}</b></td>
                    <td>${v.category || ''}</td>
                    <td><b>${v.status || ''}</b></td>
                    <td><span class="badge" style="background:white; color:black">${v.severity}</span></td>
                    <td>${v.clientName || ''}</td>
                    <td>${v.reportedNode || ''}</td>
                    <td>${v.impactedModule || ''}</td>
                    <td>${v.actionOwner || ''}</td>
                    <td>${v.dateReported || ''}</td>
                    <td>${v.eta || ''}</td>
                    <td>${v.month || ''}</td>
                    <td>${v.quarter || ''}</td>
                    <td>${v.allNodes || ''}</td>
                    <td><small>${v.comments || ''}</small></td>
                    <td>
                        <span class="action-icon" onclick="editRow('${v.id}')">‚úèÔ∏è</span>
                        <span class="action-icon" onclick="deleteItem('${v.id}')">üóëÔ∏è</span>
                    </td>
                `;
                tbody.appendChild(row);
                c.continue();
            } else { updateDashboard(s); }
        };
    }

    function updateDashboard(s) {
        document.getElementById('statTotal').innerText = s.total;
        document.getElementById('statCrit').innerText = s.crit;
        document.getElementById('statClients').innerText = s.clients.size;
        document.getElementById('statRes').innerText = (s.total > 0 ? Math.round((s.res/s.total)*100) : 0) + "%";
    }

    function editRow(id) {
        db.transaction("logs", "readonly").objectStore("logs").get(id).onsuccess = e => {
            const data = e.target.result;
            fields.forEach(f => { if(document.getElementById(f)) document.getElementById(f).value = data[f] || ""; });
            document.getElementById('editId').value = data.id;
            document.getElementById('formHeader').innerText = "üìù Editing Record: " + data.id;
            view('entryPage', document.getElementById('n1'));
        };
    }

    function exportColoredExcel() {
        const table = document.getElementById("mainTable").cloneNode(true);
        table.querySelectorAll('tr').forEach(tr => tr.lastElementChild.remove()); // Remove Actions
        
        const template = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
            <head><meta charset="UTF-8"><style>
                table { border-collapse: collapse; font-family: sans-serif; }
                th { background-color: #0f172a; color: #ffffff; border: 1px solid #000; padding: 10px; }
                td { border: 1px solid #ccc; padding: 5px; }
                .row-resolved { background-color: #dcfce7; }
                .row-progress { background-color: #fef3c7; }
                .row-critical { background-color: #fee2e2; color: #991b1b; }
            </style></head>
            <body>${table.outerHTML}</body></html>`;
        
        const blob = new Blob([template], { type: "application/vnd.ms-excel" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Master_Registry_" + new Date().toISOString().split('T')[0] + ".xls";
        a.click();
    }

    function deleteItem(id) {
        if(confirm("Permanently delete this entry?")) db.transaction("logs", "readwrite").objectStore("logs").delete(id).onsuccess = () => renderHistory();
    }

    function clearAllData() { if(confirm("This will wipe the entire database. Continue?")) db.transaction("logs", "readwrite").objectStore("logs").clear().onsuccess = () => location.reload(); }
    
    function filterTable() {
        const q = document.getElementById('tableSearch').value.toLowerCase();
        document.querySelectorAll('#logTableBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
    }

    function exportJSON() {
        db.transaction("logs", "readonly").objectStore("logs").getAll().onsuccess = e => {
            const blob = new Blob([JSON.stringify(e.target.result)], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "Backup_Aurus_Data.json";
            a.click();
        };
    }
</script>
</body>
</html>
